// Generated by CoffeeScript 1.10.0
(function() {
  var MigrationsRunner, Migrator, _, defaultLog, fs, migrationStub, mkdirp, path, repeatString,
    slice = [].slice;

  fs = require('fs');

  path = require('path');

  _ = require('lodash');

  mkdirp = require('mkdirp');

  repeatString = require('./utils').repeatString;

  migrationStub = require('./migration-stub');

  MigrationsRunner = require('./migrations-runner').MigrationsRunner;

  defaultLog = function() {
    var args, pad, src;
    src = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
    pad = repeatString(' ', src === 'system' ? 4 : 2);
    return console.log.apply(console, [pad].concat(slice.call(args)));
  };

  Migrator = (function() {
    function Migrator(dbConfig, logFn) {
      this._m = [];
      this._migrateResult = null;
      if (logFn === void 0) {
        logFn = defaultLog;
      }
      this._runner = new MigrationsRunner(dbConfig, logFn);
    }

    Migrator.prototype.add = function(m) {
      return this._m.push(m);
    };

    Migrator.prototype.bulkAdd = function(array) {
      return this._m = this._m.concat(array);
    };

    Migrator.prototype.migrate = function(done, progress) {
      var _done;
      this._migrateResult = null;
      _done = (function(_this) {
        return function(err, result) {
          _this._migrateResult = result;
          return done(err, result);
        };
      })(this);
      this._runner.runUp(this._m, _done, progress);
    };

    Migrator.prototype.rollback = function(done, progress) {
      var migrations, result;
      result = this._migrateResult;
      if (!result) {
        return done(new Error('Rollback can only be ran after migrate'));
      }
      this._migrateResult = null;
      migrations = this._m.reverse().filter(function(m) {
        var ref, status;
        return (status = (ref = result[m.id]) != null ? ref.status : void 0) && status !== 'skip';
      });
      this._runner.runDown(migrations, done, progress);
    };

    Migrator.prototype._loadMigrationFiles = function(dir, cb) {
      return mkdirp(dir, 0x1fc, function(err) {
        if (err) {
          return cb(err);
        }
        return fs.readdir(dir, function(err, files) {
          if (err) {
            return cb(err);
          }
          files = files.filter(function(f) {
            var ref;
            return ((ref = path.extname(f)) === '.js' || ref === '.coffee') && !f.startsWith('.');
          }).map(function(f) {
            var n, ref;
            n = (ref = f.match(/^(\d+)/)) != null ? ref[1] : void 0;
            if (n) {
              n = parseInt(n, 10);
            } else {
              n = null;
            }
            return {
              number: n,
              name: f
            };
          }).filter(function(f) {
            return !!f.name;
          }).sort(function(f1, f2) {
            return f1.number - f2.number;
          }).map(function(f) {
            var fileName;
            fileName = path.join(dir, f.name);
            if (fileName.match(/\.coffee$/)) {
              require('coffee-script/register');
            }
            return {
              number: f.number,
              module: require(fileName)
            };
          });
          return cb(null, files);
        });
      });
    };

    Migrator.prototype.runFromDir = function(dir, done, progress) {
      return this._loadMigrationFiles(dir, (function(_this) {
        return function(err, files) {
          if (err) {
            return done(err);
          }
          _this.bulkAdd(_.map(files, 'module'));
          return _this.migrate(done, progress);
        };
      })(this));
    };

    Migrator.prototype.create = function(dir, id, done, coffeeScript) {
      if (coffeeScript == null) {
        coffeeScript = false;
      }
      return this._loadMigrationFiles(dir, function(err, files) {
        var body, ext, fileName, maxNum, nextNum, ref, ref1, slug;
        if (err) {
          return done(err);
        }
        maxNum = (ref = (ref1 = _.maxBy(files, 'number')) != null ? ref1.number : void 0) != null ? ref : 0;
        nextNum = maxNum + 1;
        slug = (id || '').toLowerCase().replace(/\s+/, '-');
        ext = coffeeScript ? 'coffee' : 'js';
        fileName = path.join(dir, nextNum + "-" + slug + "." + ext);
        body = migrationStub(id, coffeeScript);
        return fs.writeFile(fileName, body, done);
      });
    };

    Migrator.prototype.dispose = function(cb) {
      return this._runner.dispose(cb);
    };

    return Migrator;

  })();

  module.exports.Migrator = Migrator;

}).call(this);
